---
# Apply Branch Protection Settings
# This workflow can be manually triggered to apply branch protection rules
# from the settings.yml file to the repository

name: Apply Branch Protection

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (only show what would be changed)'
        required: false
        default: 'false'
        type: boolean

jobs:
  apply-settings:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      # Need admin permissions to modify branch protection rules
      administration: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Apply branch protection for main branch
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const dryRun = ${{ inputs.dry_run }};

            // Branch protection settings
            const protection = {
              required_pull_request_reviews: {
                required_approving_review_count: 1,
                dismiss_stale_reviews: true,
                require_code_owner_reviews: false,
                bypass_pull_request_allowances: {
                  users: [],
                  teams: [],
                  apps: []
                }
              },
              required_status_checks: {
                strict: true,
                contexts: []
              },
              enforce_admins: true,  // KEY SETTING: Requires PR even for admins
              required_linear_history: false,
              allow_force_pushes: false,
              allow_deletions: false,
              required_conversation_resolution: false,
              lock_branch: false,
              restrictions: null  // No push restrictions
            };

            console.log('Branch protection settings to apply:');
            console.log(JSON.stringify(protection, null, 2));

            if (dryRun) {
              console.log('DRY RUN MODE - No changes will be made');
              console.log('Settings would be applied to main branch');
              return;
            }

            try {
              // Apply branch protection
              await github.rest.repos.updateBranchProtection({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: 'main',
                ...protection
              });

              console.log('✅ Branch protection successfully applied');
              console.log('Main branch now requires:');
              console.log('- Pull requests for all changes (including admins)');
              console.log('- At least 1 approval before merging');
              console.log('- Branches to be up to date before merging');
              console.log('- No force pushes');
              console.log('- No branch deletions');

            } catch (error) {
              console.error('❌ Failed to apply branch protection:', error);
              throw error;
            }
